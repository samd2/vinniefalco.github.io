<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
<title>Introduction</title>
<link rel="stylesheet" href="../boostbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.79.1">
<link rel="home" href="../index.html" title="NuDB">
<link rel="up" href="../index.html" title="NuDB">
<link rel="prev" href="../index.html" title="NuDB">
<link rel="next" href="overview.html" title="Overview">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<table cellpadding="2" width="100%"><tr><td valign="top"><img alt="NuDB Logo" width="1270" height="80" src="../images/logo.png"></td></tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="../index.html"><img src="../images/prev.png" alt="Prev"></a><a accesskey="u" href="../index.html"><img src="../images/up.png" alt="Up"></a><a accesskey="h" href="../index.html"><img src="../images/home.png" alt="Home"></a><a accesskey="n" href="overview.html"><img src="../images/next.png" alt="Next"></a>
</div>
<div class="section">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="nudb.intro"></a><a class="link" href="intro.html" title="Introduction">Introduction</a>
</h2></div></div></div>
<p>
      NuDB is an append only, key/value store specifically optimized for sequential
      write and random read performance on modern SSDs or equivalent high-IOPS devices.
      It does not support deletion of data. Both the write/append, read performance
      and memory usage are independent of the size of the database. A common application
      for NuDB is storage where write/append performance is important but where a
      key may be used to retrieve previously stored records.
    </p>
<p>
      The design emphasizes two goals: simplicitly and robustness/recoverability.
    </p>
<h4>
<a name="nudb.intro.h0"></a>
      <span class="phrase"><a name="nudb.intro.simplicity"></a></span><a class="link" href="intro.html#nudb.intro.simplicity">Simplicity</a>
    </h4>
<p>
      This complete program demonstrates how easy the library is easy to use. It
      creates a database, opens the database, inserts several key/value pairs, reads
      them back and displays them. Source code for this program is located in the
      examples directory.
    </p>
<pre class="programlisting"><span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">system</span><span class="special">/</span><span class="identifier">error_code</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">nudb</span><span class="special">/</span><span class="identifier">xxhasher</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>    <span class="comment">// xxhasher</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">nudb</span><span class="special">/</span><span class="identifier">create</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>      <span class="comment">// create</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">nudb</span><span class="special">/</span><span class="identifier">store</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>       <span class="comment">// store</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">nudb</span><span class="special">/</span><span class="identifier">file</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>        <span class="comment">// path_type</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">iostream</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">cstdint</span><span class="special">&gt;</span>      <span class="comment">// uint32_t, uint64_t</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">utility</span><span class="special">&gt;</span>      <span class="comment">// pair</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">string</span><span class="special">&gt;</span>       <span class="comment">// string</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">algorithm</span><span class="special">&gt;</span>    <span class="comment">// fill, copy_n, min</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">iostream</span><span class="special">&gt;</span>

<span class="keyword">int</span> <span class="identifier">main</span><span class="special">(){</span>
    <span class="comment">// error code returned by NuDb operations</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">error_code</span> <span class="identifier">ec</span><span class="special">;</span>

    <span class="comment">// key type for this example - a social security number</span>
    <span class="keyword">using</span> <span class="identifier">ssn</span> <span class="special">=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">uint64_t</span><span class="special">;</span>

    <span class="comment">// (1) File Names</span>
    <span class="keyword">const</span> <span class="identifier">nudb</span><span class="special">::</span><span class="identifier">path_type</span> <span class="identifier">dat_path</span> <span class="special">=</span> <span class="string">"db.dat"</span><span class="special">;</span>
    <span class="keyword">const</span> <span class="identifier">nudb</span><span class="special">::</span><span class="identifier">path_type</span> <span class="identifier">key_path</span> <span class="special">=</span> <span class="string">"db.key"</span><span class="special">;</span>
    <span class="keyword">const</span> <span class="identifier">nudb</span><span class="special">::</span><span class="identifier">path_type</span> <span class="identifier">log_path</span> <span class="special">=</span> <span class="string">"db.log"</span><span class="special">;</span>

    <span class="comment">// (2) Create a new database</span>
    <span class="comment">// given names of data, key and log files</span>
    <span class="identifier">nudb</span><span class="special">::</span><span class="identifier">create</span><span class="special">&lt;</span><span class="identifier">nudb</span><span class="special">::</span><span class="identifier">xxhasher</span><span class="special">&gt;(</span>
        <span class="identifier">dat_path</span><span class="special">,</span>           <span class="comment">// path name of data file</span>
        <span class="identifier">key_path</span><span class="special">,</span>           <span class="comment">// path name of key file</span>
        <span class="identifier">log_path</span><span class="special">,</span>           <span class="comment">// path name of log file</span>
        <span class="number">1</span><span class="special">,</span>                  <span class="comment">// application number</span>
        <span class="identifier">nudb</span><span class="special">::</span><span class="identifier">make_salt</span><span class="special">(),</span>  <span class="comment">// random seed</span>
        <span class="keyword">sizeof</span><span class="special">(</span><span class="identifier">ssn</span><span class="special">),</span>
        <span class="identifier">nudb</span><span class="special">::</span><span class="identifier">block_size</span><span class="special">(</span><span class="string">"."</span><span class="special">),</span> <span class="comment">// block size of current directory</span>
        <span class="number">0.5f</span><span class="special">,</span>               <span class="comment">// load factor</span>
        <span class="identifier">ec</span>                  <span class="comment">// reference to return code</span>
    <span class="special">);</span>
    <span class="keyword">if</span><span class="special">(</span><span class="identifier">ec</span><span class="special">){</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">cerr</span> <span class="special">&lt;&lt;</span> <span class="string">"creation failed:"</span> <span class="special">&lt;&lt;</span> <span class="identifier">ec</span><span class="special">.</span><span class="identifier">message</span><span class="special">()</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
        <span class="keyword">return</span> <span class="number">1</span><span class="special">;</span>
    <span class="special">}</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">cerr</span> <span class="special">&lt;&lt;</span> <span class="string">"creation successful"</span> <span class="special">&lt;&lt;</span> <span class="char">'\n'</span><span class="special">;</span>

    <span class="comment">// (3) Open an existing database</span>
    <span class="identifier">nudb</span><span class="special">::</span><span class="identifier">store</span> <span class="identifier">db</span><span class="special">;</span>
    <span class="identifier">db</span><span class="special">.</span><span class="identifier">open</span><span class="special">(</span><span class="identifier">dat_path</span><span class="special">,</span> <span class="identifier">key_path</span><span class="special">,</span> <span class="identifier">log_path</span><span class="special">,</span> <span class="identifier">ec</span><span class="special">);</span>
    <span class="keyword">if</span><span class="special">(</span><span class="identifier">ec</span><span class="special">){</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">cerr</span> <span class="special">&lt;&lt;</span> <span class="string">"open failed:"</span> <span class="special">&lt;&lt;</span> <span class="identifier">ec</span><span class="special">.</span><span class="identifier">message</span><span class="special">()</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
        <span class="keyword">return</span> <span class="number">1</span><span class="special">;</span>
    <span class="special">}</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">cerr</span> <span class="special">&lt;&lt;</span> <span class="string">"open successful"</span> <span class="special">&lt;&lt;</span> <span class="char">'\n'</span><span class="special">;</span>

    <span class="keyword">const</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">pair</span><span class="special">&lt;</span><span class="identifier">ssn</span><span class="special">,</span> <span class="keyword">const</span> <span class="keyword">char</span> <span class="special">*&gt;</span> <span class="identifier">input_data</span><span class="special">[]</span> <span class="special">=</span> <span class="special">{</span>
        <span class="special">{</span><span class="number">123456789L</span><span class="special">,</span> <span class="string">"bob"</span><span class="special">},</span>
        <span class="special">{</span><span class="number">999999999L</span><span class="special">,</span> <span class="string">"carol"</span><span class="special">},</span>
        <span class="special">{</span><span class="number">987654321L</span><span class="special">,</span> <span class="string">"ted"</span><span class="special">},</span>
        <span class="special">{</span><span class="number">666666666L</span><span class="special">,</span> <span class="string">"alice"</span><span class="special">}</span>
    <span class="special">};</span>

    <span class="comment">// (4) Insert key/value pairs</span>
    <span class="comment">// insert ssn/name pairs</span>
    <span class="keyword">for</span><span class="special">(</span><span class="keyword">const</span> <span class="keyword">auto</span> <span class="special">&amp;</span> <span class="identifier">p</span> <span class="special">:</span> <span class="identifier">input_data</span><span class="special">){</span>
        <span class="identifier">db</span><span class="special">.</span><span class="identifier">insert</span><span class="special">(&amp;</span> <span class="identifier">p</span><span class="special">.</span><span class="identifier">first</span><span class="special">,</span> <span class="identifier">p</span><span class="special">.</span><span class="identifier">second</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">strlen</span><span class="special">(</span><span class="identifier">p</span><span class="special">.</span><span class="identifier">second</span><span class="special">),</span> <span class="identifier">ec</span><span class="special">);</span>
        <span class="keyword">if</span><span class="special">(</span><span class="identifier">ec</span><span class="special">){</span>
            <span class="identifier">std</span><span class="special">::</span><span class="identifier">cerr</span> <span class="special">&lt;&lt;</span> <span class="string">"insertion failed:"</span> <span class="special">&lt;&lt;</span> <span class="identifier">ec</span><span class="special">.</span><span class="identifier">message</span><span class="special">()</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
            <span class="keyword">return</span> <span class="number">1</span><span class="special">;</span>
        <span class="special">}</span>
    <span class="special">}</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">cerr</span> <span class="special">&lt;&lt;</span> <span class="string">"inserted 4 records"</span> <span class="special">&lt;&lt;</span> <span class="char">'\n'</span><span class="special">;</span>

    <span class="comment">// (5) Fetch a value given it's key</span>
    <span class="comment">// get carol's address</span>
    <span class="identifier">ssn</span> <span class="identifier">key</span> <span class="special">=</span> <span class="number">999999999L</span><span class="special">;</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span> <span class="identifier">address</span><span class="special">;</span>
    <span class="identifier">db</span><span class="special">.</span><span class="identifier">fetch</span><span class="special">(</span>
        <span class="special">&amp;</span> <span class="identifier">key</span><span class="special">,</span>
        <span class="special">[&amp;](</span><span class="keyword">void</span> <span class="keyword">const</span> <span class="special">*</span> <span class="identifier">buffer</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">size_t</span> <span class="identifier">size</span><span class="special">){</span>
            <span class="identifier">address</span> <span class="special">=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span><span class="special">(</span><span class="keyword">static_cast</span><span class="special">&lt;</span><span class="keyword">const</span> <span class="keyword">char</span> <span class="special">*&gt;(</span><span class="identifier">buffer</span><span class="special">),</span> <span class="identifier">size</span><span class="special">);</span>
        <span class="special">},</span>
        <span class="identifier">ec</span>
    <span class="special">);</span>
    <span class="keyword">if</span><span class="special">(</span><span class="identifier">ec</span><span class="special">){</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">cerr</span> <span class="special">&lt;&lt;</span> <span class="string">"fetch failed:"</span> <span class="special">&lt;&lt;</span> <span class="identifier">ec</span><span class="special">.</span><span class="identifier">message</span><span class="special">()</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
        <span class="keyword">return</span> <span class="number">1</span><span class="special">;</span>
    <span class="special">}</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">cerr</span>
        <span class="special">&lt;&lt;</span> <span class="string">"given ssn="</span> <span class="special">&lt;&lt;</span> <span class="identifier">key</span> <span class="special">&lt;&lt;</span> <span class="string">", "</span>
        <span class="special">&lt;&lt;</span> <span class="string">"retrieved "</span> <span class="special">&lt;&lt;</span> <span class="identifier">address</span> <span class="special">&lt;&lt;</span> <span class="char">'\n'</span><span class="special">;</span>

    <span class="comment">// (6) Terminate access to the database</span>
    <span class="identifier">db</span><span class="special">.</span><span class="identifier">close</span><span class="special">(</span><span class="identifier">ec</span><span class="special">);</span>
    <span class="keyword">if</span><span class="special">(</span><span class="identifier">ec</span><span class="special">){</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">cerr</span> <span class="special">&lt;&lt;</span> <span class="string">"close failed:"</span> <span class="special">&lt;&lt;</span> <span class="identifier">ec</span><span class="special">.</span><span class="identifier">message</span><span class="special">()</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
        <span class="keyword">return</span> <span class="number">1</span><span class="special">;</span>
    <span class="special">}</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">cerr</span> <span class="special">&lt;&lt;</span> <span class="string">"close successful"</span> <span class="special">&lt;&lt;</span> <span class="char">'\n'</span><span class="special">;</span>

    <span class="keyword">return</span> <span class="number">0</span><span class="special">;</span>
<span class="special">}</span>
</pre>
<div class="variablelist">
<p class="title"><b>Notes</b></p>
<dl class="variablelist">
<dt><span class="term">(1) File names</span></dt>
<dd><p>
            A database is represented by three files: the data file, the key file,
            and the log file. Each file has a distinct header in a well known format.
            The data file holds all of the key/value pairs and is serially iterable.
            The key file holds a hash table indexing all of the contents in the data
            file. The log file holds information used to roll the database back in
            the event of a failure.
          </p></dd>
<dt><span class="term">(2) Create a new database</span></dt>
<dd><p>
            The <a class="link" href="ref/nudb__create.html" title="create"><code class="computeroutput"><span class="identifier">create</span></code></a>
            function creates a new data file and key file for a database with the
            specified parameters. The caller specifies the hash function to use as
            a template argument, the file paths, and the database constants.
          </p></dd>
<dt><span class="term">(3) Open an existing database</span></dt>
<dd><p>
            The <a class="link" href="ref/nudb__basic_store/open.html" title="basic_store::open"><code class="computeroutput"><span class="identifier">open</span></code></a>
            function prepares a database for insertion and/or reading.
          </p></dd>
<dt><span class="term">(4) Insert key/value pairs</span></dt>
<dd><p>
            Once a database is open, call the <a class="link" href="ref/nudb__basic_store/insert.html" title="basic_store::insert"><code class="computeroutput"><span class="identifier">insert</span></code></a> function to insert new
            key/value pairs. If the key already exists, the error is set to <a class="link" href="ref/nudb__error.html" title="error"><code class="computeroutput"><span class="identifier">error</span><span class="special">::</span><span class="identifier">key_exists</span></code></a>
            All keys in a NuDB database must be unique. Multiple threads can call
            insert at the same time. Internally however, insertions are serialized
            to present a consistent view of the database to callers.
          </p></dd>
<dt><span class="term">(5) Fetch a value given it's key</span></dt>
<dd><p>
            The function <a class="link" href="ref/nudb__basic_store/fetch.html" title="basic_store::fetch"><code class="computeroutput"><span class="identifier">fetch</span></code></a> takes a callback object
            as a parameter which is invoked when the value is retrieved. If there
            is no record in the database which corresponds to the key, the error
            code returns a value of <a class="link" href="ref/nudb__error.html" title="error"><code class="computeroutput"><span class="identifier">error</span><span class="special">::</span><span class="identifier">key_not_found</span></code></a>
          </p></dd>
<dt><span class="term">(6) Terminate access to the database</span></dt>
<dd><p>
            The function <a class="link" href="ref/nudb__basic_store/close.html" title="basic_store::close"><code class="computeroutput"><span class="identifier">close</span></code></a> frees all the resources
            used by the database.
          </p></dd>
</dl>
</div>
<h4>
<a name="nudb.intro.h1"></a>
      <span class="phrase"><a name="nudb.intro.robustness"></a></span><a class="link" href="intro.html#nudb.intro.robustness">Robustness</a>
    </h4>
<p>
      A second goal of the library is to create database as resistent to corruption
      as possible. Ideally, this would guarantee that any time the insert function
      successfully returns, the database is still readable an that the there is one
      and only more record appended to the database.
    </p>
<p>
      The enforcement of such a guarantee would depend on the implementation of the
      interface to underlying file system. In practice this means judicious usage
      of a "sync" function which most file systems provide in one form
      or another. The common understanding of this "sync" function is that
      it guarantees that all file operations on the files have been completed and
      that they are all reflected in the files themselves.
    </p>
<p>
      Unfortunately, it seems that most current file systems make no such guarantee.
      See <a href="https://www.usenix.org/system/files/conference/osdi14/osdi14-paper-pillai.pdf" target="_top">On
      the Complexity of Crafting Crash-Consistent Applications </a>.
    </p>
<p>
      In fact, the whole question regarding robustness turns out to be quite complicated
      as evidenced by the discussion on ths <a href="http://boost.2283326.n4.nabble.com/NuDB-A-fast-key-value-insert-only-database-for-SSD-drives-in-C-11-tp4692735.html" target="_top">Boost
      Developers mailing list</a>.
    </p>
<p>
      One simple way to investigate how this works on one's' own system is illustrated
      by the example here. The first is a program named crash.cpp which opens an
      existing database, appends one record and invokes <code class="computeroutput"><span class="identifier">std</span><span class="special">::</span><span class="identifier">abort</span><span class="special">()</span></code>.
      This program is meant to simulate a system failure such as a power outtage
      at the most inconvenient time.
    </p>
<pre class="programlisting"><span class="comment">// simulates system crash while in use.</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">system</span><span class="special">/</span><span class="identifier">error_code</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">nudb</span><span class="special">/</span><span class="identifier">store</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>       <span class="comment">// store</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">iostream</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">cstdint</span><span class="special">&gt;</span>  <span class="comment">// std::uint32_t, std::uint64_t</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">cstdlib</span><span class="special">&gt;</span>  <span class="comment">// std::abort</span>

<span class="keyword">int</span> <span class="identifier">main</span><span class="special">(){</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">error_code</span> <span class="identifier">ec</span><span class="special">;</span>

    <span class="comment">// key type for this example</span>
    <span class="keyword">using</span> <span class="identifier">ssn</span> <span class="special">=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">uint64_t</span><span class="special">;</span>

    <span class="comment">// Open an existing database</span>
    <span class="identifier">nudb</span><span class="special">::</span><span class="identifier">store</span> <span class="identifier">db</span><span class="special">;</span>
    <span class="identifier">db</span><span class="special">.</span><span class="identifier">open</span><span class="special">(</span><span class="string">"db.dat"</span><span class="special">,</span> <span class="string">"db.key"</span><span class="special">,</span> <span class="string">"db.log"</span><span class="special">,</span> <span class="identifier">ec</span><span class="special">);</span>
    <span class="keyword">if</span><span class="special">(</span><span class="identifier">ec</span><span class="special">){</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">cerr</span> <span class="special">&lt;&lt;</span> <span class="string">"open failed: "</span> <span class="special">&lt;&lt;</span> <span class="identifier">ec</span><span class="special">.</span><span class="identifier">message</span><span class="special">()</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
        <span class="keyword">return</span> <span class="number">1</span><span class="special">;</span>
    <span class="special">}</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">cerr</span> <span class="special">&lt;&lt;</span> <span class="string">"open successful"</span> <span class="special">&lt;&lt;</span> <span class="char">'\n'</span><span class="special">;</span>

    <span class="identifier">ssn</span> <span class="identifier">key</span> <span class="special">=</span> <span class="number">777777777L</span><span class="special">;</span>
    <span class="keyword">const</span> <span class="keyword">char</span> <span class="special">*</span> <span class="identifier">name</span> <span class="special">=</span> <span class="string">"george"</span><span class="special">;</span>

    <span class="comment">// insert a ssn/name pair</span>
    <span class="identifier">db</span><span class="special">.</span><span class="identifier">insert</span><span class="special">(&amp;</span> <span class="identifier">key</span><span class="special">,</span> <span class="identifier">name</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">strlen</span><span class="special">(</span><span class="identifier">name</span><span class="special">),</span> <span class="identifier">ec</span><span class="special">);</span>

    <span class="comment">// simulate a crash</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">abort</span><span class="special">();</span>

    <span class="keyword">return</span> <span class="number">1</span><span class="special">;</span>
<span class="special">}</span>
</pre>
<p>
      After running this program, the database would be in some unknown state. Specifically,
      does the database contain the record for the name "george". In fact,
      it's not even clear that the database is readable at all.
    </p>
<p>
      This last program opens up the database and lists all it's members. The includes
      a function named <a class="link" href="ref/nudb__recover.html" title="recover"><code class="computeroutput"><span class="identifier">recover</span></code></a>
      for fixing errors in a corrupted database such as one which might be result
      from a crashed environment. But it is not necessary to invoke it explicitly
      as the normal <a class="link" href="ref/nudb__basic_store/open.html" title="basic_store::open"><code class="computeroutput"><span class="identifier">open</span></code></a> includes that functionality.
      So we can just open the database and list all the records counting on the libary
      implementation to detect any corruption resulting from previous operations.
    </p>
<p>
      Listing all the contents of the database invokes a user specified function
      for each pair of key and value. Here is a simple program which lists all the
      data in our sample.
    </p>
<pre class="programlisting"><span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">system</span><span class="special">/</span><span class="identifier">error_code</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">nudb</span><span class="special">/</span><span class="identifier">xxhasher</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>    <span class="comment">// xxhasher</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">nudb</span><span class="special">/</span><span class="identifier">create</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>      <span class="comment">// create</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">nudb</span><span class="special">/</span><span class="identifier">store</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>       <span class="comment">// store</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">nudb</span><span class="special">/</span><span class="identifier">visit</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">nudb</span><span class="special">/</span><span class="identifier">progress</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>

<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">iostream</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">cstdint</span><span class="special">&gt;</span>  <span class="comment">// std::uint32_t, std::uint64_t</span>

<span class="keyword">int</span> <span class="identifier">main</span><span class="special">(){</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">error_code</span> <span class="identifier">ec</span><span class="special">;</span>

    <span class="comment">// key type for this example</span>
    <span class="keyword">using</span> <span class="identifier">ssn</span> <span class="special">=</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">uint64_t</span><span class="special">;</span>

    <span class="comment">// Open an existing database</span>
    <span class="identifier">nudb</span><span class="special">::</span><span class="identifier">store</span> <span class="identifier">db</span><span class="special">;</span>
    <span class="identifier">db</span><span class="special">.</span><span class="identifier">open</span><span class="special">(</span><span class="string">"db.dat"</span><span class="special">,</span> <span class="string">"db.key"</span><span class="special">,</span> <span class="string">"db.log"</span><span class="special">,</span> <span class="identifier">ec</span><span class="special">);</span>
    <span class="keyword">if</span><span class="special">(</span><span class="identifier">ec</span><span class="special">){</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">cerr</span> <span class="special">&lt;&lt;</span> <span class="string">"open failed: "</span> <span class="special">&lt;&lt;</span> <span class="identifier">ec</span><span class="special">.</span><span class="identifier">message</span><span class="special">()</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
        <span class="keyword">return</span> <span class="number">1</span><span class="special">;</span>
    <span class="special">}</span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">cerr</span> <span class="special">&lt;&lt;</span> <span class="string">"open successful"</span> <span class="special">&lt;&lt;</span> <span class="char">'\n'</span><span class="special">;</span>

    <span class="identifier">nudb</span><span class="special">::</span><span class="identifier">visit</span><span class="special">(</span>
        <span class="string">"db.dat"</span><span class="special">,</span>
        <span class="special">[&amp;](//</span> <span class="identifier">called</span> <span class="identifier">with</span> <span class="identifier">each</span> <span class="identifier">item</span> <span class="identifier">found</span> <span class="identifier">in</span> <span class="identifier">the</span> <span class="identifier">data</span> <span class="identifier">file</span>
            <span class="keyword">void</span> <span class="keyword">const</span><span class="special">*</span> <span class="identifier">key</span><span class="special">,</span>                <span class="comment">// A pointer to the item key</span>
            <span class="identifier">std</span><span class="special">::</span><span class="identifier">size_t</span> <span class="identifier">key_size</span><span class="special">,</span>           <span class="comment">// The size of the key (always the same)</span>
            <span class="keyword">void</span> <span class="keyword">const</span><span class="special">*</span> <span class="identifier">data</span><span class="special">,</span>               <span class="comment">// A pointer to the item data</span>
            <span class="identifier">std</span><span class="special">::</span><span class="identifier">size_t</span> <span class="identifier">data_size</span><span class="special">,</span>          <span class="comment">// The size of the item data</span>
            <span class="identifier">boost</span><span class="special">::</span><span class="identifier">system</span><span class="special">::</span><span class="identifier">error_code</span><span class="special">&amp;</span> <span class="identifier">ec</span>   <span class="comment">// Indicates an error (out parameter)</span>
        <span class="special">){</span>
            <span class="keyword">if</span><span class="special">(</span><span class="identifier">ec</span><span class="special">){</span>
                <span class="identifier">std</span><span class="special">::</span><span class="identifier">cerr</span> <span class="special">&lt;&lt;</span> <span class="string">"visit failed: "</span> <span class="special">&lt;&lt;</span> <span class="identifier">ec</span><span class="special">.</span><span class="identifier">message</span><span class="special">()</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
                <span class="keyword">return</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">terminate</span><span class="special">();</span>
            <span class="special">}</span>
            <span class="identifier">std</span><span class="special">::</span><span class="identifier">cerr</span>
                <span class="special">&lt;&lt;</span> <span class="string">"key: "</span> <span class="special">&lt;&lt;</span> <span class="special">*</span> <span class="keyword">static_cast</span><span class="special">&lt;</span><span class="keyword">const</span> <span class="identifier">ssn</span> <span class="special">*&gt;(</span><span class="identifier">key</span><span class="special">)</span> <span class="special">&lt;&lt;</span> <span class="char">'\n'</span>
                <span class="special">&lt;&lt;</span> <span class="string">"name: "</span> <span class="special">&lt;&lt;</span>
                    <span class="identifier">std</span><span class="special">::</span><span class="identifier">string</span><span class="special">(</span><span class="keyword">static_cast</span><span class="special">&lt;</span><span class="keyword">const</span> <span class="keyword">char</span> <span class="special">*&gt;(</span><span class="identifier">data</span><span class="special">),</span> <span class="identifier">data_size</span><span class="special">)</span> <span class="special">&lt;&lt;</span> <span class="char">'\n'</span>
            <span class="special">;</span>
        <span class="special">},</span>
        <span class="special">[&amp;](//</span> <span class="identifier">called</span> <span class="identifier">to</span> <span class="identifier">indicate</span> <span class="identifier">progress</span> <span class="identifier">of</span> <span class="identifier">visitation</span>
            <span class="identifier">std</span><span class="special">::</span><span class="identifier">uint64_t</span> <span class="identifier">amount</span><span class="special">,</span>   <span class="comment">// Amount of work done so far</span>
            <span class="identifier">std</span><span class="special">::</span><span class="identifier">uint64_t</span> <span class="identifier">total</span>     <span class="comment">// Total amount of work to do</span>
        <span class="special">){</span>
            <span class="comment">// we ignore this information in this example</span>
        <span class="special">},</span>
        <span class="identifier">ec</span>  <span class="comment">// result of visit operation</span>
    <span class="special">);</span>
    <span class="keyword">if</span><span class="special">(</span><span class="identifier">ec</span><span class="special">){</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">cerr</span> <span class="special">&lt;&lt;</span> <span class="string">"visit failed: "</span> <span class="special">&lt;&lt;</span> <span class="identifier">ec</span><span class="special">.</span><span class="identifier">message</span><span class="special">()</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
        <span class="keyword">return</span> <span class="number">1</span><span class="special">;</span>
    <span class="special">}</span>
    <span class="keyword">return</span> <span class="number">0</span><span class="special">;</span>
<span class="special">}</span>
</pre>
<p>
      Invoking this program on our test database produces the followning output.
    </p>
<pre class="programlisting">open successful
key: 123456789
name: bob
key: 666666666
name: alice
key: 987654321
name: ted
key: 999999999
name: carol
</pre>
<p>
      which shows that on this particular platform (Mac OSX), return from an insert
      operation does not guarantee that a record is actually appended to the database.
    </p>
<p>
      The library includes an test suite with more examples similar to the above
      which can be used to get a better understanding of the utility and robustness
      in one's own environment.
    </p>
</div>
<table xmlns:rev="http://www.cs.rpi.edu/~gregod/boost/tools/doc/revision" width="100%"><tr>
<td align="left"></td>
<td align="right"><div class="copyright-footer">Copyright &#169; 2015, 2016 Vinnie Falco<p>
        Distributed under the Boost Software License, Version 1.0. (See accompanying
        file LICENSE_1_0.txt or copy at <a href="http://www.boost.org/LICENSE_1_0.txt" target="_top">http://www.boost.org/LICENSE_1_0.txt</a>)
      </p>
</div></td>
</tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="../index.html"><img src="../images/prev.png" alt="Prev"></a><a accesskey="u" href="../index.html"><img src="../images/up.png" alt="Up"></a><a accesskey="h" href="../index.html"><img src="../images/home.png" alt="Home"></a><a accesskey="n" href="overview.html"><img src="../images/next.png" alt="Next"></a>
</div>
</body>
</html>
